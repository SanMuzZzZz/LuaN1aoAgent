<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>鸾鸟Agent Operation Center</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <!-- [新增] 引入 dagre 用于计算 DAG 布局 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>

<div id="app">
  <header id="topbar">
    <div class="brand">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
      鸾鸟Agent
    </div>
    <div style="width:1px;height:24px;background:var(--border-color)"></div>
    <div class="flex gap-2">
      <button class="btn active" data-view="exec" onclick="switchView('exec')">攻击图</button>
      <button class="btn" data-view="causal" onclick="switchView('causal')">因果图</button>
    </div>
    <div style="flex:1"></div>
    <div class="flex gap-2 items-center">
      <input id="in-goal" placeholder="输入目标..." style="width: 200px;">
      <input id="in-task" placeholder="任务ID" style="width: 80px;">
      <button class="btn btn-primary" onclick="createTask()">新建</button>
    </div>
    <div style="width:1px;height:24px;background:var(--border-color);margin:0 10px;"></div>
    <div class="flex gap-2">
      <button class="btn" onclick="openMCPModal()" title="MCP服务">MCP</button>
      <button class="btn" onclick="openInjectModal()" title="注入任务">Inject</button>
      <button class="btn" onclick="render(true)" title="刷新">Refresh</button>
      <button class="btn btn-danger" onclick="abortOp()" title="终止">Stop</button>
    </div>
  </header>

  <div id="layout">
    <aside id="sidebar">
      <div class="panel-header">Operations</div>
      <ul id="ops"></ul>
    </aside>

    <main id="main">
      <svg id="d3-graph" width="100%" height="100%"></svg>
      <div id="controls" class="floating-panel">
        <button class="btn" onclick="zoomIn()">+</button>
        <button class="btn" onclick="zoomOut()">-</button>
        <button class="btn" onclick="zoomReset()">Fit</button>
      </div>
      <div id="legend" class="floating-panel">
        <div style="font-weight:600;margin-bottom:6px;font-size:10px;text-transform:uppercase">Legend</div>
        <div id="legend-content"></div>
      </div>
      
      <div id="node-details-panel" class="floating-details" style="top: 20px; left: 20px;">
        <div class="panel-header">
          <span>Node Details</span>
          <button class="btn" style="height:24px;padding:0 6px;background:transparent;border:none;" onclick="closeDetails()">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <div id="node-detail-content" class="panel-content">
          <div style="padding:20px;color:var(--text-muted);text-align:center">Select a node</div>
        </div>
      </div>
    </main>

    <aside id="right-panel">
      <div id="llm-output-container">
        <div class="panel-header">
          <span>Agent Logs (Output Only)</span>
          <span id="typing-indicator" style="display:none;color:var(--success)">● Live</span>
        </div>
        <div id="llm-stream" class="panel-content"></div>
      </div>
    </aside>
  </div>
</div>

<div id="inject-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="panel-header" style="background:transparent;border:none;padding:24px 24px 0;">
      <h2 style="font-size:16px;">Inject Task</h2>
    </div>
    <div class="modal-body">
      <div class="mb-4"><label class="block text-xs text-gray-400 mb-1">Description</label><textarea id="inject-desc" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white h-24"></textarea></div>
      <div class="mb-4"><label class="block text-xs text-gray-400 mb-1">Dependencies (IDs)</label><input id="inject-deps" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white"></div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeModals()">Cancel</button><button class="btn btn-primary" onclick="submitInjection()">Inject</button></div>
  </div>
</div>

<div id="mcp-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="panel-header" style="background:transparent;border:none;padding:24px 24px 0;">
      <h2 style="font-size:16px;">Manage MCP Servers</h2>
    </div>
    <div class="modal-body">
      <div class="mb-4">
        <div class="text-xs text-gray-400 mb-2 uppercase font-bold">Current Servers</div>
        <div id="mcp-list" class="bg-slate-800 border border-slate-600 rounded p-2 text-white text-xs" style="min-height:50px; max-height:150px; overflow-y:auto;">Loading...</div>
      </div>
      <hr class="border-slate-700 my-4">
      <div class="mb-2 text-xs text-gray-400 uppercase font-bold">Add New Server</div>
      <div class="mb-2"><label class="block text-xs text-gray-400 mb-1">Name</label><input id="mcp-name" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white"></div>
      <div class="mb-2"><label class="block text-xs text-gray-400 mb-1">Command</label><input id="mcp-cmd" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white"></div>
      <div class="mb-2"><label class="block text-xs text-gray-400 mb-1">Args (comma separated)</label><input id="mcp-args" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white"></div>
      <div class="mb-2"><label class="block text-xs text-gray-400 mb-1">Env (JSON)</label><textarea id="mcp-env" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white h-16" placeholder='{"KEY": "VALUE"}'></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn" onclick="closeModals()">Close</button><button class="btn btn-primary" onclick="addMCPServer()">Add & Reload</button></div>
  </div>
</div>

<div id="approval-modal" class="modal-overlay">
  <div class="modal-box" style="width:700px;">
    <div class="panel-header" style="background:var(--warning);color:#000;border:none;">HITL Approval Required</div>
    <div class="modal-body">
      <div style="margin-bottom:12px;color:var(--text-muted)">Agent proposed plan:</div>
      <div id="approval-list" style="max-height:300px;overflow-y:auto;"></div>
      <div id="approval-edit-area" style="display:none;"><textarea id="approval-json-editor" style="width:100%;height:300px;font-family:var(--font-code);background:var(--bg-app);color:var(--text-main);border:1px solid var(--border-color);padding:10px;"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="submitDecision('REJECT')">Reject</button>
      <div style="flex:1"></div>
      <button class="btn" id="btn-modify-mode" onclick="toggleModifyMode()">Modify</button>
      <button class="btn btn-primary" onclick="submitDecision('APPROVE')">Approve</button>
    </div>
  </div>
</div>

<script src="/static/app.js"></script>
</body>
</html>