### 过滤器检测与绕过方法论 (Filter Detection & Bypass Methodology)

## 通用过滤器分析框架

适用于所有注入类漏洞：SQL注入、命令注入、XSS、SSTI、LFI、SSRF等

### 阶段1: 基线建立 (Baseline Establishment)

**目的**: 建立正常响应的参考基准

**步骤**:
1. 发送一个正常的、预期的请求
2. 记录完整响应特征:
   - 状态码 (200, 302, 404等)
   - 响应长度（精确到字节）
   - 响应时间（多次采样取平均）
   - 关键头部（Content-Type, Set-Cookie等）
   - 响应体结构（HTML标签、JSON字段等）

**重要性**: 所有后续差异分析都基于这个基线

### 阶段2: 探针注入 (Probe Injection)

**目的**: 系统性地测试过滤器的存在和行为

{% raw %}**最小探针集**（按优先级）:
1. **特殊字符探针**: `'`, `"`, `<`, `>`, `{`, `}`, `;`, `|`, `&`
2. **空白字符探针**: 空格, Tab(`\t`), 换行(`\n`), 回车(`\r`)
3. **关键字探针**（漏洞特定）:
   - SQL: `select`, `union`, `or`, `and`, `--`
   - XSS: `script`, `alert`, `onerror`, `onload`
   - SSTI: `{{`, `}}`, `config`, `request`
   - 命令注入: `cat`, `ls`, `whoami`, `id`{% endraw %}

**探针注入策略**:
- **隔离测试**: 每个探针单独发送，精确定位被过滤的字符
- **组合测试**: 测试字符组合的过滤规则（如`'`可以但`' or`被过滤）
- **位置测试**: 在不同参数位置（URL、Body、Header、Cookie）测试

### 阶段3: 差异分析 (Differential Analysis)

**目的**: 识别过滤器触发的精确信号

**分析维度**:

1. **状态码变化**:
   - `200 → 403/406`: WAF拦截或输入验证失败
   - `200 → 500`: 触发后端错误（可能是注入成功信号）
   - `200 → 302`: 重定向到错误页面或登录页

2. **响应长度差异**:
   - 长度增加: 可能插入了错误消息或警告
   - 长度减少: 可能字符被过滤删除
   - 长度不变: 可能字符被替换或转义

3. **响应时间异常**:
   - 显著延迟（>2秒）: 可能触发WAF深度检查
   - 超时: 可能触发资源耗尽或死循环

4. **响应内容变化**:
   - 出现`filtered`, `blocked`, `invalid`等关键词
   - 回显中字符消失或被替换（如`<script>` → `&lt;script&gt;`）
   - 出现错误栈或数据库错误信息

5. **头部变化**:
   - 新增`X-WAF-*`头部
   - Cookie被清空或重置
   - `Content-Type`变化

**差异判断矩阵**:
```
无差异 → 探针通过，无过滤
状态码变化 → 服务器端拦截
内容变化 → 字符过滤或转义
时间延迟 → WAF检测或盲注信号
```

### 阶段4: 过滤器类型推断 (Filter Type Inference)

基于测试结果推断过滤器机制:

**类型A: 黑名单过滤器**
- 特征: 特定字符/关键字被拦截，其他通过
- 证据: `select`被拦截但`SeLeCt`通过
- 绕过策略: 编码、大小写、同义替换

**类型B: 白名单过滤器**
- 特征: 只允许特定字符集，其他全拦截
- 证据: 字母数字通过，所有特殊字符被拦截
- 绕过策略: 寻找白名单内的可利用字符组合

**类型C: 正则过滤器**
- 特征: 匹配特定模式被拦截
- 证据: `' or 1=1`被拦截但`' or 1=2`通过（关键词组合触发）
- 绕过策略: 破坏正则模式（插入注释、换行）

**类型D: WAF (Web Application Firewall)**
- 特征: 多维度检测（IP、频率、Payload特征）
- 证据: 同一Payload在不同IP/时间有不同结果
- 绕过策略: 分片、编码、延迟、IP轮换

**类型E: 编码层过滤**
- 特征: 在HTTP传输层进行编码转换
- 证据: `<script>`在URL中被自动URL编码
- 绕过策略: 使用RawMode、调整Content-Type

### 阶段5: 系统化绕过 (Systematic Bypass)

**绕过技术分类**:

#### 1. 编码绕过 (Encoding Bypass)
- **URL编码**: `%27` = `'`, `%3C` = `<`
- **双重URL编码**: `%2527` = `%27` = `'`
- **HTML实体编码**: `&lt;` = `<`, `&#60;` = `<`, `&#x3c;` = `<`
- **Base64编码**: 适用于支持解码的场景
- **十六进制编码**: `0x27` = `'` (SQL), `\x3c` = `<` (JavaScript)
- **Unicode编码**: `\u003c` = `<`, `\u0027` = `'`

#### 2. 语法变异绕过 (Syntax Mutation)
- **大小写混淆**: `SeLeCt`, `UnIoN`, `<ScRiPt>`
- **注释插入**: 
  - SQL: `SE/**/LECT`, `UN/*comment*/ION`
  - 命令: `ca''t`, `c\at`
- **空白符替换**:
  - SQL: `/**/`, `%0a`, `%09`, `%0d`
  - 命令: `${IFS}`, `$IFS$9`, `{cat,/etc/passwd}`
- **等价替换**:
  - SQL: `AND` → `&&`, `OR` → `||`, `=` → `LIKE`
  - XSS: `<img src=x onerror=...>` → `<svg/onload=...>`

#### 3. 逻辑绕过 (Logic Bypass)
- **字符串拼接**:
  - SQL: `'ad'+'min'`, `CONCAT('ad','min')`
  - JavaScript: `'ale'+'rt'`, `eval('ale'+'rt(1)')`
- **函数嵌套**: `CHAR(65)` = `A`, `FROM_BASE64(...)`
- **条件表达式**: `CASE WHEN ... THEN ... END`

#### 4. 协议/上下文绕过
- **参数位置变换**: POST → GET, Cookie → Header
- **HTTP方法变换**: GET → POST → PUT → DELETE
- **Content-Type修改**: 
  - `application/x-www-form-urlencoded` → `application/json`
  - `multipart/form-data` → `text/plain`
- **HTTP版本**: HTTP/1.1 → HTTP/2.0

### 阶段6: 智能重试与验证 (Intelligent Retry & Validation)

**迭代测试策略**:
1. 记录每次绕过尝试的结果
2. 根据反馈调整下一次尝试
3. 构建"成功绕过模式库"
4. 对成功Payload进行最小化验证

**验证清单**:
- [ ] Payload在基线请求中通过过滤
- [ ] Payload产生预期的漏洞效果
- [ ] Payload在多次请求中稳定可复现
- [ ] Payload的成功原因已明确归因

## 智能过滤器识别响应框架

**⚠️ 当检测到过滤行为时，自动触发系统化分析流程**

### 触发条件
- 初步测试Payload被过滤
- 返回错误信息包含过滤关键词
- 出现异常响应（状态码/长度/时间变化）

### 响应策略
1. **立即切换到过滤器分析模式**（而非继续盲目尝试）
2. **系统化测试字符集**（而非随机测试）
3. **构建过滤器画像**（类型、范围、强度）
4. **查询绕过知识库**（如需要）

### 最佳实践

**使用`python_exec`进行批量测试**:
```python
# 批量测试字符过滤
chars = ["'", '"', '<', '>', '{', '}', ';', '|', '&', '(', ')']
results = {}
for char in chars:
    payload = f"test{char}test"
    response = send_request(payload)
    results[char] = {
        'status': response.status_code,
        'length': len(response.text),
        'blocked': 'filtered' in response.text.lower()
    }
# 分析结果，识别被过滤的字符模式
```

{% raw %}**RawMode强制复测**:
当Payload包含特殊字符（`<`, `>`, `{`, `}`, `'`, `"`）时:
- 必须使用 `raw_mode: true` 重新发送
- 设置合适的`Content-Type`（如`text/html`, `application/json`）
- 对比编码前后的响应差异{% endraw %}

### 知识检索升级时机

当遇到以下情况时，触发`retrieve_knowledge` → `expert_analysis`:
1. 明确识别出特定WAF（如ModSecurity、Cloudflare）
2. 标准绕过技术全部失败
3. 遇到特定框架的特殊过滤机制
4. 需要针对特定技术栈的高级绕过技巧

**检索查询优化**:
- 精准查询: `"<漏洞类型> <过滤器类型>绕过"`
- 示例: `"SQL注入 黑名单过滤器绕过"`, `"SSTI Jinja2沙箱逃逸"`
