### 过滤器逆向工程协议 (Filter Reverse-Engineering Protocol, FREP)

## 核心原则 [CRITICAL]

**当检测到过滤器时，不是"尝试绕过"，而是"完整逆向过滤器逻辑"。**

反应式方法（❌）：`尝试A → 失败 → 尝试B → 失败 → ...`
系统性方法（✅）：`触发FREP → 穷举维度 → 逆向规则 → 组合绕过 → 精准利用`

---

## 阶段 1: 触发条件识别

当观察到以下任一信号时，**必须触发 FREP**，暂停当前利用尝试：

| 信号类型 | 示例 |
|----------|------|
| **拦截关键词** | "blocked", "filtered", "not allowed", "invalid", "WAF" |
| **差异信号** | 状态码变化（200→403）、响应长度突变 |
| **标签提示** | "unsupported tag", "security constraint triggered" |
| **特定拦截器** | ModSecurity, Cloudflare, AWS WAF 触发特征 |

**重要**：FREP 仅用于**约束逆向**，不能替代语境验证。即使正在执行 FREP，仍需完成对引号矩阵和占位符的基线对照。

---

## 阶段 2: 归因验证协议 (Attribution Verification Protocol) [CRITICAL]

**问题**: 当复合载荷 (如 `' OR '1'='1`) 触发过滤时，无法确定是哪个元素导致过滤。

**原则**: **禁止使用复合载荷进行归因。必须先分解为原子单元，逐个验证。**

### 2.1 原子分解规则
将任意载荷分解为以下原子类别并单独重测：

| 原子类别 | 示例 |
|---------|------|
| **结构字符** | `'`, `"`, `(`, `)`, `;`, `#`, `--` |
| **技术关键词** | `OR`, `AND`, `UNION`, `SELECT`, `script`, `eval` |
| **分隔符/填充** | 空格, Tab, 换行, `/**/`, `+` |
| **算术运算符** | `=`, `<`, `>`, `||`, `&&` |
| **特定模式** | `1=1`, `admin`, `passwd` |

### 2.2 单变量测试流程 (Iterative Attribution)
1. **基线验证**: 确认不包含任何敏感字符的原始请求成功。
2. **增量测试**: 在基线基础上，**每次仅添加一个**原子单元进行测试。
3. **负向测试**: 如果 `SELECT` 被过滤，测试 `SELeCT` (大小写) 或 `SELSELECTECT` (双写)。
4. **排除法**: 如果 `' OR '1'='1` 报错，分别测试 `'`, `OR`, `1=1`。如果 `'` 通过但 `OR` 失败，归因为关键词过滤。

---

## 阶段 3: 边界条件探测 (Boundary Probe)

### 3.1 编码一致性测试
- **RawMode 验证**: 强制对比 URL 编码与原始字符的过滤差异。
- **多重编码测试**: 在 WAF 之后可能存在后端二次解析（如双重 URL 编码）。

### 3.2 字符例外探测 (Exception Mapping)
- **单一字符指纹**: 检查特定字符是否被作为"特殊标识符"（如某些 WAF 仅拦截特定集合外的首个敏感字符）。
- **零宽/不可见字符**: 测试 `%00`, `%0a`, `%0b` 对解析流程的影响。

---

## 阶段 4: 系统化策略组合

根据归因结果，选择对应的绕过策略：

1. **关键词归因**: 使用大小写、注释插入（`UNI/**/ON`）、等价替换（`&&` 替 `AND`）。
2. **结构符归因**: 使用编码（URL/Hex）、重叠（`'""'`）、转义绕过。
3. **模式匹配归因**: 破坏正则特征，如在 `OR` 后添加非标准空格或换行。

---

## 5. 验证清单 (Verification Checklist)
- [ ] 归因是否已降维至原子级别？（而非猜测是整体被过滤）
- [ ] 绕过载荷是否经过了最小化精简？（排除干扰项）
- [ ] 成功绕过是否具备逻辑解释？（例如：因为服务器仅拦截小写 select）
